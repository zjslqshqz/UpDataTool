(function($){$.fn.UpDataTool=function(options){var opt=$.fn.extend({},$.fn.UpDataTool.Mod_Defaults,options);this.on('click',function(){var info=$.fn.UpDataTool.TestOptinos(opt);if(info.RS!==1){opt.callback_Error(info);return false};var dom_file_id=$(this).data("input_id");if(typeof(dom_file_id)!=='undefined'&&dom_file_id!==''){$("#"+dom_file_id).click()}else{var Mod_length=$("body").data("UpDataTool_length");if(!$.isNumeric(Mod_length)){Mod_length=0;$("body").data("UpDataTool_length",Mod_length)}else{$("body").data("UpDataTool_length",Mod_length++)};var input_id=opt.InputObj+"_"+Mod_length;var m="";if(opt.Multiple){m="multiple='true'"};$("body").append("<input class='"+opt.ModClassName+"' id='"+input_id+"' type='file' style='opacity: 0;position: absolute;z-index: -1;top: 0;left: 0;' accept='"+opt.Accept+"' "+m+">");$(this).data("input_id",input_id);$(this).addClass("UpDataTool");$("body #"+input_id).click();var ThisDomData=$(this);switch(opt.SendType){case 1:$("#"+input_id).on('change',function(){$.fn.UpDataTool.LoadPost_fun(opt,this.files,ThisDomData)});break;case 2:$(opt.SendDomObj).off("click");$(opt.SendDomObj).on("click",function(){if($("#"+input_id).length!==0){$.fn.UpDataTool.LoadPost_fun(opt,$("#"+input_id)[0].files,ThisDomData)}else{opt.callback_LocalPreview({RS:-1,Msg:'请先选择需要上传的文件'})}});if(opt.LocalPreview){if(opt.Accept.indexOf('png')>-1||opt.Accept.indexOf('jpeg')>-1){$("#"+input_id).on('change',function(){var data=this.files;$.each(data,function(i,o){var reader=new FileReader();reader.readAsDataURL(o);reader.onload=function(e){opt.callback_LocalPreview({RS:1,Msg:this.result})}})})}else{opt.callback_Error({RS:-1,Msg:'本地预览功能，当前只支持图片[png][jpg]格式'})}};break}}})};$.fn.UpDataTool.DataPost_Fun=function(Optinos,FileData){var infoObj={};var errInfo=0;$.each(FileData,function(i,o){if(Optinos.Accept.indexOf(o.type)=='-1'){Optinos.callback_Error({RS:-1,Msg:'请选择正确的文件类型'});errInfo=1;return false};if(o.size>Optinos.FileSize){var Max=Math.round((Optinos.FileSize*100)/(1024*1024))/100;Optinos.callback_Error({RS:-1,Msg:'图片文件不能大于'+Max+'MB'});errInfo=1;return false}});if(errInfo!==0){infoObj.Info=false;return infoObj};var fd=new FormData();$.each(FileData,function(i,o){fd.append(Optinos.UpDataKey+'_'+i,o)});var OtherData=Optinos.event_OtherData();if(OtherData===false){}else{if(!$.isPlainObject(OtherData)){var obj={};obj.RS=-1;obj.Msg='[event_OtherData()]:返回内容不是obj对象';Optinos.callback_Error(obj);infoObj.Info=false;return infoObj}else{var e=0;var obj={};$.each(OtherData,function(i,o){if($.isArray(o)||$.isPlainObject(o)){obj.RS=-1;obj.Msg='OtherData:参数数据中值不能为数组或对象类型';return false}});if(e!==0){Optinos.callback_Error(obj);infoObj.Info=false;return infoObj}}}if(!$.isEmptyObject(OtherData)&&!$.isArray(OtherData)){for(var key in OtherData){var obj=OtherData[key];fd.append(key,obj)}};infoObj.Info=true;infoObj.Data=fd;return infoObj};$.fn.UpDataTool.DataSend_fun=function(Optinos,Data,DomData){var LoadStart=function(data){$("body").append($.fn.UpDataTool.LoadProgressHTML());$("#"+Optinos.ModClassName+"_LoadProgress").show();var obj={};obj.RS=1;obj.Msg='开始';Optinos.callback_LoadStart(obj)};var LoadProgress=function(data){var obj={};if(data.lengthComputable){obj.RS=1;obj.PercentComplete=Math.round(data.loaded*100/data.total)}else{obj.RS=-1;obj.Msg='无法计算'}$("#"+Optinos.ModClassName+"_LoadProgress").css('width',obj.PercentComplete+"%");$("#"+Optinos.ModClassName+"_LoadProgressLoadText span").text(obj.PercentComplete);Optinos.callback_LoadProgress(obj)};var LoadComplete=function(data){$("#"+DomData.data("input_id")).remove();DomData.data("input_id",'');DomData.removeClass("UpDataTool");var l=$("body").data("UpDataTool_length");if(l===0){$("body").data("UpDataTool_length",'')}else{$("body").data("UpDataTool_length",l--)}$("#"+Optinos.ModClassName+"_LoadProgressHTML_Back").remove();$("#"+Optinos.ModClassName+"_LoadProgressHTML").remove();Optinos.callback_LoadComplete(data.target.responseText)};var LoadError=function(data){var obj={};obj.RS=-1;obj.Msg='尝试上传文件时出错';Optinos.callback_Error(obj)};var LoadCanceled=function(data){var obj={};obj.RS=-1;obj.Msg='用户已取消上载或浏览器中断连接';Optinos.callback_LoadCanceled(obj)};var xhr=new XMLHttpRequest();xhr.addEventListener("loadstart",LoadStart,false);xhr.upload.addEventListener("progress",LoadProgress,false);xhr.addEventListener("load",LoadComplete,false);xhr.addEventListener("error",LoadError,false);xhr.addEventListener("abort",LoadCanceled,false);xhr.open("POST",Optinos.Server);xhr.send(Data)};$.fn.UpDataTool.LoadPost_fun=function(Optinos,Data,DomData){var FilesData=($.fn.UpDataTool.DataPost_Fun(Optinos,Data));if(FilesData.Info){$.fn.UpDataTool.DataSend_fun(Optinos,FilesData.Data,DomData)}};$.fn.UpDataTool.LoadProgressHTML=function(){var html='<Div id="'+$.fn.UpDataTool.Mod_Defaults.ModClassName+'_LoadProgressHTML_Back" style="position: fixed; left:0; top: 0; opacity: 0.3; background-color: #000; width: 100%; height: 100%; z-index: 9;"></Div>'+'<DIV class="'+$.fn.UpDataTool.Mod_Defaults.ModClassName+'_LoadHTMLBox" id="'+$.fn.UpDataTool.Mod_Defaults.ModClassName+'_LoadProgressHTML" style=" position: fixed; z-index: 10; top: 30%; left: 25%; width: 350px; border-radius: 2px; background-color: #ffffff; box-shadow: 1px 1px 50px rgba(0,0,0,.3);-webkit-animation-fill-mode: both;animation-fill-mode: both;-webkit-animation-duration: .3s;animation-duration: .3s;-webkit-animation-name: bounceIn;animation-name: bounceIn;">'+'<div class="box" style="width: 90%; padding: 0 5%;"> '+'<ul class="jd" style="width: 100%; height: 18px; margin: 0; padding:0;  margin-top: 20px; float: left; background-color: #f1f1f1; border: 1px solid #e5e5e5; border-radius: 5px; list-style-type:none;"> '+'<li id="'+$.fn.UpDataTool.Mod_Defaults.ModClassName+'_LoadProgress" style="width: 0; height: 18px; background-color: #00ae43; float: left; list-style-type:none;"></li> '+'</ul> '+'<ul class="u2" style="width: 100%; float: left; text-align: center; color: #838282;padding: 0; padding-bottom: 20px; margin: 0;"> '+'<li class="t" id="'+$.fn.UpDataTool.Mod_Defaults.ModClassName+'_LoadProgressLoadText" style="font-size: 18px; color: #333; list-style-type:none;">更新进度：<span>0</span>%</li> '+'<li style="list-style-type:none;">正在更新数据，请不要关闭或刷新页面</li> '+'</ul> '+'</div>'+'</DIV>';return html};$.fn.UpDataTool.Mod_Defaults={SendType:1,SendDomObj:'',InputObj:'Mod_UpDataTool',ModClassName:'Mod_UpDataTool',UpDataKey:'Mod_UpDataTool_file',event_OtherData:function(){return false},Server:'',Multiple:false,LocalPreview:false,Accept:'image/png,image/jpeg',FileSize:2097152,callback_Error:function(data){console.log(data)},callback_LoadStart:function(data){},callback_LoadProgress:function(data){},callback_LoadComplete:function(data){},callback_LoadError:function(data){},callback_LoadCanceled:function(data){},callback_LocalPreview:function(data){}};$.fn.UpDataTool.TestOptinos=function(Optinos){var obj={RS:1};$.each(Optinos,function(i,o){if(i==='SendType'){if(o===1||o===2){}else{obj.RS=-1;obj.Msg='参数[SendType]错误：当前只支持两种模式，int[2]手动触发上传事件，int[1]选择图片后自动触发上传事件'}};if(i==='SendDomObj'){if(o===2){if(Optinos.SendDomObj!==''){}else{obj.RS=-1;obj.Msg="参数[SendDomObj]错误：只接受字符类型，如[#id][.className]"}}};if(i==='Server'){if(o===''){obj.RS=-1;obj.Msg="参数[Server]错误：请输入正确的服务端接受路径"}};if(i==='Multiple'){if(typeof(o)==='boolean'){}else{obj.RS=-1;obj.Msg="参数[Multiple]错误：请输入正确的类型[true][false]"}};if(i==='LocalPreview'){if(o===true){if(Optinos.SendType===2){}else{obj.RS=-1;obj.Msg="参数[LocalPreview]错误：本地预览功能，只在手动上传模式下开启，请设置参数[SendType]为[2]"}}};if(i==='FileSize'){if($.isNumeric(o)&&o>0){}else{obj.RS=-1;obj.Msg="参数[FileSize]错误：请输入正确的类型int[2097152]"}}});return obj}})(jQuery);